---
title: The Relative Importance of Region and Vaccination in Predicting COVID-19 Cases
  in U.S. Counties
author: "Lev El-Askari"
date: "9/5/2021"
output:rmarkdown::github_document
---

 
```{r include=FALSE}
setwd("~/COVID Side Project")
```

### The Relative Importance of Region and Vaccination in Predicting COVID-19 Cases in U.S. Counties?
At the beginning of Summer 2021, the COVID-19 pandemic looked to be behind us. Cases, hospitalizations, and deaths were at the lowest levels since the beginning of the pandemic, spurred by what appeared to be a combination of warm weather and increasing vaccinations. However, the emergence of the Delta Variant quickly upended this sense of normality. 

While cases have risen everywhere, rates have been highest in the South/Southeast and lowest in the Northeast. This trend corresponds to the South/Southeast having the lowest vaccination rate of any region, while the Northeast has the highest. This seems intuitive: higher vaccination rate, lower case rate.

But what if it wasn't so simple? Let's remember that COVID-19 waves followed regional patterns before vaccines were in widespread use. The first wave of March 2020 hit the Northeast particularly hard, followed by a summer wave that primarily affected the South and Sunbelt. There is speculation about the effect of differing climates, with harsher weather keeping people indoors where COVID-19 spreads rampantly and mild weather driving people outdoors where spread is rare. However, for our purposes here, it doesn't matter why COVID-19 waves follow regional patterns, just that they do. So, what is behind the current surge in cases in the South and Southeast? Is it due to regional patterns, low vaccination levels, or both? Based on my analysis, I will show that in the United States, vaccination rates matter, but region also plays a substantial role in determining case rates.

For this analysis, I will be looking at county-level data. Comparing vaccination levels and case rates by state gives incomplete information because vaccination levels vary considerably within states. In general, highly populated urban areas have much higher vaccination rates than sparsely populated rural areas. For example, in Wake County, NC, 71% of those eligible are fully vaccinated, compared to 26% in Stanly County, NC (a rural county outside of Charlotte). Therefore, one way to examine the relationship between vaccination rates and COVID-19 case rates while controlling for regional effects is to use multiple linear regression (MLR), with region and vaccination levels as predictors.
This analysis has two components: 

1. Visualizing the link between vaccination levels and case rates by county within regions of the United States
2. Building MLR models to determine whether case rates are best predicted by region, vaccination levels, or both.

I found that counties with higher vaccination rates had lower case rates than counties with lower vaccination rates, even when controlling for region. However, region was a more powerful predictor of case rates, indicating that we may experience more seasonal waves of COVID-19 regardless of vaccination rates.


### Load packages and data
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(MASS)

# load county data with rolling averages for cases and hospitalizations from New York Times database
county_case <- read_csv("us-counties.csv") 

# load vaccination data by county from CDC
vax <- read_csv("COVID-19_Vaccinations_in_the_United_States_County.csv") 

# load population data
pop <- read_csv("county_complete.csv")
```

### Clean case data
First, we need to filter for data between July 7, 2021 and September 5, 2021. This captures the Delta-variant wave that we are examining. Then we get the fips code from the geoID (it's just the numbers in the code). This is what we will use to merge the data with the vaccination data by county and the population data by county.

```{r}
county_case<- county_case %>% 
  filter(date >= as.Date("2021-07-06") & date <= as.Date("2021-09-5")) %>% 
  mutate(fips = as.numeric(substr(geoid, 5, 9))) %>% 
  dplyr::select(county, state, cases, fips)
```

### Create aggregated county data
Now, we aggregate the cases for each county in each state during the Delta surge. This will give us one row per county.
```{r}
counties_agg <- county_case %>% 
  group_by(fips) %>% 
  dplyr::summarise(
            county = unique(county),
            state = unique(state),
            cases = sum(cases))
```

### Join population data set to cases data set to get case rate per 100,000 people
```{r}
# select just fips code and population
pop <- pop %>% 
  dplyr::select(fips, pop2017)

# join data and create case_rate, which is the rate per 100,000 people
counties_agg <- counties_agg %>% 
  inner_join(pop, by = "fips") %>% 
  mutate(case_rate = (cases/pop2017) * 100000)
```


### Clean vaccination data
Clean fips variable for merging and remove NAs. We filter for 7/06/2021 because this is when the 7-day average for cases began rising in the US due to the Delta variant. Therefore, the vaccination rate from that date is a good indicator of how much protection counties would have against the Delta surge. Note that the vaccination rate refers to the percent fully vaccinated (2 weeks after final dose).
```{r message=FALSE, warning=FALSE}
vax <- vax %>% 
  dplyr::rename(fully_vax = Series_Complete_Pop_Pct,
         fips = FIPS)%>% 
  filter(Date == "07/06/2021" & !(is.na(fips))) %>% 
  mutate(fips = as.numeric(fips)) %>% 
  dplyr::select(fips, fully_vax)
```

### Join the vaccination and case rate data
```{r}
# inner join to only include counties that have a case rate and a vaccination rate
vax_case <- vax %>% 
  inner_join(counties_agg, by = "fips")
```

### How does the percent fully vaccinated relate to case rate per 100,000?
We exclude counties that report 0% or 100% vaccinated because this is impossible since children under 12 are not yet eligible. We also exclude counties where the case rate is 0 over the last 7 days as these won't be useful in our analysis and is likely due to a lack of reporting.
```{r message=FALSE}
# exclude counties with suspicious numbers
vax_case <- vax_case %>% 
  filter(fully_vax > 0 & fully_vax < 99 &  case_rate > 0) 

# plot vaccination rate and case rate
vax_case %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the United States", x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```


##### There appears to be a negative relationship between vaccination rate and case rate
We can run a correlation test to test for significance and the strength of the relationship
```{r}
# get alpha level based on sample size
a = 1-pchisq(log(nrow(vax_case)),1)
a
# use alpha level of 0.0048 for remainder of analysis

# correlation test
cor.test(vax_case$fully_vax, vax_case$case_rate)
```

There is a significant negative correlation between vaccination rate and case rate. The correlation is -0.335.

### So, counties with higher vaccination rates have fewer cases 
##### However, could there be a third variable at play here?
The most vaccinated states are mostly in the Northeast, where the weather is milder this time of year. The least vaccinated states are mostly in the South, where the it extremely hot, pushing people indoors. Last summer, before vaccines were available, we saw this pattern of cases rising in the southern US and remaining lower in the northern US. Could it be that the climate and seasons are driving the cases up in the South which happens to have many counties with low rates of vaccination?

### Let's look at counties within climate regions in the United States to control for seasonal effects
##### Create regions by climate 
COVID-19 waves have been observed to follow seasonal patterns related to climate. We can create regions based on climate using the National Centers for Environmental Information(source: https://www.ncdc.noaa.gov/monitoring-references/maps/us-climate-regions.php). Alaska and Hawaii are excluded since they don't fit into the climate zones of the US.
```{r}
vax_case <- vax_case %>% 
  mutate(region = case_when(state %in% c("Connecticut","Maine","Massachusetts","New Hampshire",
             "Rhode Island","Vermont","New Jersey","New York",
             "Pennsylvania", "Delaware", "Maryland" ) ~ "Northeast",
             state %in% c("Alabama", "Florida", "Georgia", "North Carolina", "South Carolina", "Virginia") ~ "Southeast",
             state %in% c("Illinois", "Indiana", "Kentucky", "Missouri", "Ohio", "Tennessee", "West Virginia") ~ "Ohio Valley",
             state %in% c("Iowa", "Michigan", "Minnesota", "Wisconsin") ~ "Upper Midwest",
             state %in% c("Idaho", "Oregon", "Washington") ~ "Northwest",
             state %in% c("Arkansas", "Kansas", "Louisiana", "Mississippi", "Oklahoma", "Texas") ~ "South",
             state %in% c("Arizona", "Colorado", "New Mexico", "Utah") ~ "Southwest",
             state %in% c("California", "Nevada") ~ "West",
             state %in% c("Montana", "Nebraska", "North Dakota", "South Dakota", "Wyoming") ~ "North Rockies/Plains"))

```

### Let's look at the relationship between vaccination rate and case rate for each climate region

##### Northeast
```{r}
vax_case %>% 
  filter(region == "Northeast") %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the Northeast", x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```

##### Southeast
```{r}
vax_case %>% 
  filter(region == "Southeast") %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the Southeast",x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```

##### West
```{r}
vax_case %>% 
  filter(region == "West") %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the West",x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```


##### Southwest
```{r}
vax_case %>% 
  filter(region == "Southwest") %>%
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the Southwest",x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```


##### Upper Midwest
```{r}
vax_case %>% 
  filter(region == "Upper Midwest") %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the Upper Midwest",x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```

## South
```{r}
vax_case %>% 
  filter(region == "South") %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the South",x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```

##### Ohio Valley
```{r}
vax_case %>% 
  filter(region == "Ohio Valley") %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the Ohio Valley",x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```

##### Northwest
```{r}
vax_case %>% 
  filter(region == "Northwest") %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the Northwest",x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```

##### Northern Rockies and Plains
```{r}
vax_case %>% 
  filter(region == "North Rockies/Plains") %>% 
  ggplot(aes(x = fully_vax, y = case_rate))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Vaccination Levels and Case Rates in the Northern Rockies and Plains",x = "Percent Fully Vaccinated", y = "Case Rate per 100,000")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```


### Let's examine a bar chart of the correlations for each region
```{r}
# create table with the correlation between case rate and vaccination rate in each region
cor_case_region <- vax_case %>% 
  group_by(region) %>% 
  dplyr::summarise(correlation = cor(fully_vax, case_rate))

# plot the correlation for each region
cor_case_region %>%
  filter(!is.na(region)) %>% 
  mutate(region = fct_reorder(region, correlation), .fun='mean') %>% 
  ggplot(aes(x = region, y = correlation))+
  geom_col(fill = "#4472C4")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(x = "Region", y = "Correlation", title = "Correlation Between Vaccination Level and COVID-19 Case Rate by Region")+
  ylim(c(-0.4, 0.2))
```

### Are any of these correlations significant?
```{r message=FALSE, warning=FALSE}
# create table of significance levels for each region
vax_case %>% 
  nest(-region) %>% 
  mutate(cor=map(data,~cor.test(.x$fully_vax, .x$case_rate))) %>%
  mutate(tidied = map(cor, tidy)) %>% 
  unnest(tidied, .drop = T) %>% 
  dplyr::select(region, estimate, p.value) %>% 
  filter(!is.na(region)) %>% 
  mutate(estimate = round(estimate, 3),
         p.value = round(p.value, 5)) %>% 
  arrange(p.value)

```

Three out of the nine regions had a significant negative relationship between case rate rates and vaccination rates. No regions had a positive relationship. This indicates a general trend, where higher vaccination rate is associated with higher case rate. However, this effect is not as strong as indicated by the graph of the entire US. Maybe region is playing a large role here. Let's examine to see if this is the case.

### Case rate by region of the US
```{r}
# plot the case rate for each region
vax_case %>% 
  group_by(region) %>% 
  summarise(case_rate = mean(case_rate)) %>% 
  filter(!(is.na(region))) %>% 
  mutate(region = fct_reorder(region, desc(case_rate)), .fun='mean') %>%
  ggplot(aes(x = region, y = case_rate))+
  geom_col(fill = "orange2")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title = "Case Rate per Region", x = "Region", y = "Case Rate (per 100,000)")+
  theme(plot.title = element_text(hjust = 0.5))
```

From this plot, you can see that case rate varies widely by region. Now, we need to parse out whether it is the region itself or the differing vaccination rates by region that is driving this relationship. 

Now let's build some regression models to determine whether case rate is best predicted by region, vaccination rate, or a combination of the two.

### Region predicting case rate
```{r}
case1 <- lm(vax_case$case_rate ~ vax_case$region)
summary(case1)
```

Here you can see that region is a significant predictor of case rate. Let's check the assumptions for simple linear regression before proceeding.

##### Check assumptions
```{r}
# Examine assumptions
par(mfrow=c(2,2))
plot(case1)
```

From the residual vs. fitted plot and Q-Q plot, it appears that the assumptions for equal variance and normality aren't holding. Let's try a Box-Cox transformation to see if we can address this.

##### Box-Cox Transformation
```{r}
boxcox(case1)
```

This indicates that a square root transformation may be helpful. Let's try it.

### Region predicting case rate with a square root transformation
```{r}
case1sqrt <- lm(sqrt(vax_case$case_rate) ~ vax_case$region)
summary(case1sqrt)
```

This improved our adjusted R^2 from 0.38 to 0.44. Let's see if it helped meet the assumptions

##### Check assumptions
```{r}
# Examine assumptions
par(mfrow=c(2,2))
plot(case1sqrt)
```

The square root transformation of case rate improved the model and fulfilled the assumptions. Great! Now, let's look at vaccination rate predicting case rate.

### Vaccination rate predicting case rate
```{r}
case2 <- lm(vax_case$case_rate~ vax_case$fully_vax)
summary(case2)
```

##### Check assumptions
```{r}
# Examine assumptions
par(mfrow=c(2,2))
plot(case2)

```
Here, we are seeing a fan-shaped Residual vs. Fitted plot and some issues with the Q-Q plot. Let's try a Box-Cox transformation

##### Box-Cox Transformation
```{r}
boxcox(case2)
```

This indicates that a square root transformation may be helpful. Let's try it.

### Vaccination rate predicting case rate with a square root transformation
```{r}
case2sqrt <- lm(sqrt(vax_case$case_rate) ~ vax_case$fully_vax)
summary(case2sqrt)
```
This improved our adjusted R^2 from 0.11 to 0.12. Let's see if it helped meet the assumptions

```{r}
# Examine assumptions
par(mfrow=c(2,2))
plot(case2sqrt)
```

The square root transformation of case rate improved the model and fulfilled the assumptions.

Now, let's build a model with both region and vaccination rate. This will allow us to see if vaccination rate explains any additional variance in case rates beyond that which is explained by region

### Vaccination rate and region predicting case rate
```{r}
case3 <- lm(vax_case$case_rate ~ vax_case$fully_vax + vax_case$region)
summary(case3)
```

##### Check assumptions
```{r}
# Examine assumptions
par(mfrow=c(2,2))
plot(case3)
```

Equal variance and normality are not being met. Let's try a Box-Cox Transformation

```{r}
boxcox(case3)
```
This indicates that a square root transformation might be helpful.

### Region and vaccination rate predicting case rate with a square root transformation
```{r}
case3sqrt <- lm(sqrt(vax_case$case_rate) ~ vax_case$region + vax_case$fully_vax)
summary(case3sqrt)
```
This improved our adjusted R^2 from 0.38 to 0.44. Let's see if it helped meet the assumptions

```{r}
# Examine assumptions
par(mfrow=c(2,2))
plot(case3sqrt)
```

The square root transformation of case rate improved the model and fulfilled the assumptions.


Now we want to look at the relative importance of region and vaccination rate in predicting case rate. To do this, we can examine how the R^2 changes for each model when we add the other variable. This change in R2 represents the additional variance in case rates explained by adding the other variable. 

# Change in R^2
```{r}
print(paste("Change in R^2 of Region to Region + Vaccination:", summary(case3sqrt)$r.squared - summary(case1sqrt)$r.squared))
print(paste("Change in R^2 of Vaccination to Vaccination + Region:", summary(case3sqrt)$r.squared - summary(case2sqrt)$r.squared))
```

When adding vaccination to a region-only model, there was a change in R^2 of 0.0035 (0.35% additional explained variance). When adding region to a vaccination-only model, there was a change in R^2 of 0.3280 (32.80% additional explained variance).

# Takeaways  

This analysis presents two clear findings:

1.	Counties with higher vaccinations had lower case rates, even when controlling for region
2.	Region was better than vaccination levels at predicting case rates

This has several important implications. First, increasing vaccinations may help reduce the spread of COVID-19. Vaccinations should be encouraged for this reason, in addition to their demonstrated effects of reducing severe disease, hospitalization, and death on an individual level. 
Additionally, there may be under-looked regional effects that drive surges in COVID-19 cases, meaning that COVID-19 is unlikely to be eradicated due to increased vaccination. Instead, it could become endemic, continuing to have regional surges in the coming years. 
We may need to begin to think of vaccinations as our ticket to living with COVID-19 rather than without it.

























